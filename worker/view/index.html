<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <!-- import CSS -->
    <link rel="stylesheet" href="/css/element-ui.css">
</head>

<body>
    <div id="app">
        <el-input style="width:250px" placeholder="please input node address" prefix-icon="el-icon-search" v-model="address">
        </el-input>
        <el-button style="margin-left:5px" type="primary" icon="el-icon-search" circle @click="searchAddress"></el-button>
        <el-tree style="margin-top:20px" :load="loadNodeEdge" :props="props" lazy></el-tree>
    </div>
</body>
<!-- import Vue before Element -->
<script src="/js/vue.js"></script>
<!-- import JavaScript -->
<script src="/js/element-ui.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
    new Vue({
        el: '#app',
        data: function () {
            return {
                props: {
                    label: 'name'
                },
                address: '',
                root: { name: 'root', id: 0 }
            }
        },
        methods: {
            loadNodeEdge(node, resolve) {
                var vm = this;
                if (node.level === 0) {
                    return resolve([this.root]);
                }
                var data = node.data;
                if (node.level > 0) {
                    if (data.edges) {
                        var task = data.edges.map(e => {
                            return axios.get(`/ordinal/${e.to_node}`).then(res => res.data)
                        });
                        Promise.all(task).then(list => {
                            var result = list.map(r => {
                                if (r.ok) {
                                    return {
                                        name: r.data.name,
                                        id: r.data.id,
                                        edges: r.data.edges
                                    }
                                }
                            }).filter(r => r);
                            resolve(result);
                        }).catch(err => vm.$message.error(err));
                    }
                }
            },
            searchAddress() {
                if (!this.address) return;
                if (this.address[0] !== '@') {
                    this.$message.error('node address must starts with \'@\'!');
                }
                var vm = this;
                axios.get(`/address/${vm.address}`)
                    .then(res => {
                        let data = res.data;
                        if (data.ok) {
                            data = res.data && res.data.data;
                            vm.root.name = data.name;
                            vm.root.id = data.id;
                            vm.root.edges = data.edges;
                        } else {
                            vm.$message.error(data.message);
                        }
                    })
                    .catch(err => vm.$message.error(err));
            }
        }
    })

</script>

</html>